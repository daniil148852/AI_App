name: Build Debug APK

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'

  pull_request:
    branches:
      - main
      - develop

  workflow_dispatch:
    inputs:
      build_notes:
        description: 'Build notes'
        required: false
        default: 'Manual debug build'

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Debug APK
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ═══ Generate missing launcher icons ═══
      - name: Generate launcher icons
        run: |
          for density in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
            mkdir -p app/src/main/res/mipmap-${density}
          done

          sudo apt-get update -qq && sudo apt-get install -y -qq imagemagick > /dev/null 2>&1

          declare -A sizes=(
            ["mdpi"]=48
            ["hdpi"]=72
            ["xhdpi"]=96
            ["xxhdpi"]=144
            ["xxxhdpi"]=192
          )

          for density in "${!sizes[@]}"; do
            size=${sizes[$density]}
            convert -size ${size}x${size} xc:'#6750A4' \
              -fill white -gravity center \
              -pointsize $((size/3)) -annotate 0 'AI' \
              "app/src/main/res/mipmap-${density}/ic_launcher.png"
            cp "app/src/main/res/mipmap-${density}/ic_launcher.png" \
               "app/src/main/res/mipmap-${density}/ic_launcher_round.png"
          done

          echo "✅ Launcher icons generated"

      # ═══ Build ═══
      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon --stacktrace
        env:
          GRADLE_OPTS: >-
            -Xmx4g
            -XX:MaxMetaspaceSize=1g
            -XX:+HeapDumpOnOutOfMemoryError
            -Dfile.encoding=UTF-8

      - name: Verify APK exists
        run: |
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" -type f | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "::error::APK file not found!"
            exit 1
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "APK_NAME=$(basename $APK_PATH)" >> $GITHUB_ENV
          APK_SIZE=$(du -sh "$APK_PATH" | cut -f1)
          echo "✅ APK built successfully: $APK_SIZE"

      - name: Rename APK
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE=$(date +'%Y%m%d')
          BRANCH=$(echo "${{ github.ref_name }}" | sed 's/\//-/g')
          NEW_NAME="AI-Phone-Assistant-debug-${DATE}-${BRANCH}-${SHORT_SHA}.apk"
          cp "${{ env.APK_PATH }}" "app/build/outputs/apk/debug/${NEW_NAME}"
          echo "RENAMED_APK=app/build/outputs/apk/debug/${NEW_NAME}" >> $GITHUB_ENV
          echo "RENAMED_APK_NAME=${NEW_NAME}" >> $GITHUB_ENV

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: ${{ env.RENAMED_APK }}
          retention-days: 30
          if-no-files-found: error
          compression-level: 0

      - name: Upload build reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: |
            app/build/reports/
            app/build/outputs/logs/
          retention-days: 7

      - name: Build Summary
        if: success()
        run: |
          APK_SIZE=$(du -sh "${{ env.RENAMED_APK }}" | cut -f1)
          echo "## ✅ Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **APK** | \`${{ env.RENAMED_APK_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Size** | ${APK_SIZE} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`$(echo ${{ github.sha }} | cut -c1-7)\` |" >> $GITHUB_STEP_SUMMARY
